@model HWSETA_Impact_Hub.Models.ViewModels.Enrollment.EnrollmentDocumentUploadVm
@{
    ViewData["Title"] = "Upload Enrollment Document";
}

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

<link href="~/css/enrollmentupload.css" rel="stylesheet" />

<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
    <div>
        <div class="hw-page-eyebrow"><i class="bi bi-upload me-1"></i>Enrolment Documents</div>
        <h1 class="hw-page-title">Upload <span>Document</span></h1>
    </div>
    <a asp-action="Index" asp-route-enrollmentId="@Model.EnrollmentId" class="hw-btn-outline" style="margin-top:4px;">
        <i class="bi bi-arrow-left"></i> Back to Documents
    </a>
</div>

<div class="hw-layout">

    @* ── Main form ── *@
    <div class="hw-card">
        <div class="hw-card-head">
            <div class="hw-card-icon green"><i class="bi bi-cloud-upload"></i></div>
            <div>
                <div class="hw-card-title">Upload Enrolment Document</div>
                <div class="hw-card-sub">Supported: PDF, Word, Excel, images up to 20 MB</div>
            </div>
        </div>
        <div class="hw-card-body">
            @if (!ViewData.ModelState.IsValid && ViewData.ModelState.TryGetValue(string.Empty, out var re) && re.Errors.Count > 0)
            {
                <div class="hw-val-summary" role="alert">
                    <i class="bi bi-exclamation-circle-fill" style="flex-shrink:0;font-size:16px;margin-top:1px;"></i>
                    <div><strong>Please fix:</strong><ul>@foreach (var e in re.Errors) {
                    <li>@e.ErrorMessage</li>
                }
</ul></div>
            </div>
                        }
            <form method="post" enctype="multipart/form-data" id="hw-upload-form">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="EnrollmentId" />

                <div class="hw-field">
                    <label asp-for="DocumentTypeId" class="hw-field-label">Document Type <span class="hw-req">*</span></label>
                    <div class="hw-field-wrap">
                        <i class="bi bi-tag hw-field-ico"></i>
                        <select asp-for="DocumentTypeId" asp-items="Model.DocumentTypes" class="hw-select" id="hw-doc-type">
                            <option value="">— Select document type —</option>
                        </select>
                    </div>
                    <span asp-validation-for="DocumentTypeId" class="hw-field-error"></span>
                </div>

                <div class="hw-field" style="margin-bottom:0;">
                    <label class="hw-field-label">File <span class="hw-req">*</span></label>

                    <div class="hw-drop-zone" id="hw-drop-zone">
                        <input asp-for="File" type="file" id="hw-file-input"
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.webp"
                               onchange="hwFileChosen(this)" />
                        <div id="hw-drop-placeholder">
                            <div class="hw-drop-icon"><i class="bi bi-cloud-arrow-up"></i></div>
                            <div class="hw-drop-title">Drop your file here or click to browse</div>
                            <div class="hw-drop-sub">PDF, Word, Excel or image files</div>
                            <span class="hw-drop-limit"><i class="bi bi-shield-check" style="font-size:10px;"></i> Max 20 MB</span>
                        </div>
                    </div>

                    <div class="hw-file-preview" id="hw-file-preview">
                        <div class="hw-preview-icon"><i class="bi bi-file-earmark-check" id="hw-preview-icon-i"></i></div>
                        <div>
                            <div class="hw-preview-name" id="hw-preview-name">filename.pdf</div>
                            <div class="hw-preview-size" id="hw-preview-size">0 KB</div>
                        </div>
                        <button type="button" class="hw-preview-remove" id="hw-remove-btn" onclick="hwClearFile()" title="Remove file">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>

                    <span asp-validation-for="File" class="hw-field-error" style="margin-top:6px;"></span>
                </div>
            </form>
        </div>
        <div class="hw-card-foot">
            <button type="submit" form="hw-upload-form" class="hw-btn-primary" id="hw-submit-btn">
                <i class="bi bi-upload"></i> Upload Document
            </button>
            <a asp-action="Index" asp-route-enrollmentId="@Model.EnrollmentId" class="hw-btn-outline">
                <i class="bi bi-x"></i> Cancel
            </a>
        </div>
    </div>

    @* ── Sidebar ── *@
    <div style="display:flex;flex-direction:column;gap:16px;">

        @* Accepted formats *@
        <div class="hw-card">
            <div class="hw-card-head">
                <div class="hw-card-icon dark"><i class="bi bi-file-earmark-check"></i></div>
                <div><div class="hw-card-title">Accepted Formats</div></div>
            </div>
            <div class="hw-card-body" style="padding:16px 20px;">
                <div class="hw-formats">
                    <span class="hw-format-tag pdf"><i class="bi bi-file-earmark-pdf" style="font-family:unset !important;"></i> .pdf</span>
                    <span class="hw-format-tag doc">.doc</span>
                    <span class="hw-format-tag doc">.docx</span>
                    <span class="hw-format-tag xls">.xls</span>
                    <span class="hw-format-tag xls">.xlsx</span>
                    <span class="hw-format-tag img">.jpg</span>
                    <span class="hw-format-tag img">.jpeg</span>
                    <span class="hw-format-tag img">.png</span>
                    <span class="hw-format-tag img">.webp</span>
                </div>
                <div style="margin-top:12px;padding:10px 12px;background:var(--hw-offwhite);border:1px solid var(--hw-border);border-radius:8px;display:flex;gap:8px;align-items:flex-start;">
                    <i class="bi bi-info-circle" style="color:var(--hw-gold-dark);flex-shrink:0;margin-top:1px;"></i>
                    <span style="font-size:11.5px;color:var(--hw-muted);line-height:1.5;">Maximum file size: <strong style="color:var(--hw-dark);">20 MB</strong>. Larger files will be rejected.</span>
                </div>
            </div>
        </div>

        @* Tips *@
        <div class="hw-card">
            <div class="hw-card-head">
                <div class="hw-card-icon gold"><i class="bi bi-lightbulb"></i></div>
                <div><div class="hw-card-title">Upload Tips</div></div>
            </div>
            <div class="hw-card-body" style="padding:16px 20px;">
                <ul class="hw-tip-list">
                    <li class="hw-tip-item"><i class="bi bi-check-circle-fill"></i>Select the correct <strong>Document Type</strong> before uploading — this helps filter and retrieve files later.</li>
                    <li class="hw-tip-item"><i class="bi bi-check-circle-fill"></i>Use descriptive filenames (e.g. <code style="font-size:10.5px;background:#f1f2f5;padding:1px 5px;border-radius:4px;">ID_copy_John_Doe.pdf</code>).</li>
                    <li class="hw-tip-item"><i class="bi bi-check-circle-fill"></i>Scan physical documents at minimum 150 DPI for legibility.</li>
                    <li class="hw-tip-item"><i class="bi bi-check-circle-fill"></i>You can upload multiple documents — repeat this process for each file.</li>
                    <li class="hw-tip-item"><i class="bi bi-check-circle-fill"></i>Uploaded files are linked to this specific enrolment and can be downloaded by authorised users.</li>
                </ul>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Drag & drop
        const zone = document.getElementById('hw-drop-zone');
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            const inp = document.getElementById('hw-file-input');
            inp.files = e.dataTransfer.files;
            hwFileChosen(inp);
        });

        function hwFileChosen(inp) {
            if (!inp.files || !inp.files[0]) return;
            const file = inp.files[0];

            // Validate size (20 MB)
            if (file.size > 20 * 1024 * 1024) {
                if (typeof hwToast === 'function') hwToast('error', 'File Too Large', 'Please choose a file smaller than 20 MB.');
                hwClearFile(); return;
            }

            const ext = file.name.split('.').pop().toLowerCase();
            const iconMap = { pdf:'bi-file-earmark-pdf', doc:'bi-file-earmark-word', docx:'bi-file-earmark-word', xls:'bi-file-earmark-excel', xlsx:'bi-file-earmark-excel', jpg:'bi-file-earmark-image', jpeg:'bi-file-earmark-image', png:'bi-file-earmark-image', webp:'bi-file-earmark-image' };

            document.getElementById('hw-preview-name').textContent  = file.name;
            document.getElementById('hw-preview-size').textContent  = hwFmtSize(file.size);
            document.getElementById('hw-preview-icon-i').className  = 'bi ' + (iconMap[ext] || 'bi-file-earmark');
            document.getElementById('hw-file-preview').classList.add('show');
            document.getElementById('hw-drop-placeholder').style.display = 'none';
            zone.classList.add('has-file');
        }

        function hwClearFile() {
            const inp = document.getElementById('hw-file-input');
            inp.value = '';
            document.getElementById('hw-file-preview').classList.remove('show');
            document.getElementById('hw-drop-placeholder').style.display = '';
            zone.classList.remove('has-file');
        }

        function hwFmtSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Mark validation errors
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('span[data-valmsg-for]').forEach(function (span) {
                if (span.textContent.trim()) {
                    var inp = document.querySelector('[name="' + span.getAttribute('data-valmsg-for') + '"]');
                    if (inp) inp.classList.add('input-error');
                }
            });
        });
    </script>
}
