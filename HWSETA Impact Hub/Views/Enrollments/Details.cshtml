@model HWSETA_Impact_Hub.Domain.Entities.Enrollment
@using HWSETA_Impact_Hub.Domain.Entities
@{
    ViewData["Title"] = "Enrollment Details";
    var history = ViewBag.History as List<EnrollmentStatusHistory> ?? new();
    var statusVm = ViewBag.StatusVm as HWSETA_Impact_Hub.Models.ViewModels.Enrollment.EnrollmentStatusUpdateVm
                   ?? new HWSETA_Impact_Hub.Models.ViewModels.Enrollment.EnrollmentStatusUpdateVm { EnrollmentId = Model.Id };
}

<h1 class="mb-3">Enrollment Details</h1>

<div class="card mb-3">
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Cohort</dt>
            <dd class="col-sm-9">@Model.Cohort?.CohortCode</dd>

            <dt class="col-sm-3">Beneficiary</dt>
            <dd class="col-sm-9">@($"{Model.Beneficiary?.LastName}, {Model.Beneficiary?.FirstName} ({Model.Beneficiary?.IdentifierValue})")</dd>

            <dt class="col-sm-3">Programme</dt>
            <dd class="col-sm-9">@Model.Cohort?.Programme?.ProgrammeName</dd>

            <dt class="col-sm-3">Provider</dt>
            <dd class="col-sm-9">@Model.Cohort?.Provider?.ProviderName</dd>

            <dt class="col-sm-3">Employer</dt>
            <dd class="col-sm-9">@((Model.Cohort?.Employer == null) ? "-" : Model.Cohort.Employer.EmployerCode)</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9"><span class="badge bg-info">@Model.CurrentStatus</span></dd>

            <dt class="col-sm-3">Start</dt>
            <dd class="col-sm-9">@Model.StartDate.ToString("yyyy-MM-dd")</dd>

            <dt class="col-sm-3">Actual End</dt>
            <dd class="col-sm-9">@((Model.ActualEndDate.HasValue) ? Model.ActualEndDate.Value.ToString("yyyy-MM-dd") : "-")</dd>

            <dt class="col-sm-3">Notes</dt>
            <dd class="col-sm-9">@Model.Notes</dd>
        </dl>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">Update Status</div>
    <div class="card-body">
        <form asp-action="UpdateStatus" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="EnrollmentId" value="@statusVm.EnrollmentId" />

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select name="Status" class="form-select">
                        @foreach (var s in Enum.GetValues(typeof(EnrollmentStatus)).Cast<EnrollmentStatus>())
                        {
                            <option value="@s" selected="@(s == Model.CurrentStatus)">@s</option>
                        }
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Status Date</label>
                    <input name="StatusDate" type="date" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Reason</label>
                    <input name="Reason" class="form-control" />
                </div>

                <div class="col-md-12">
                    <label class="form-label">Comment</label>
                    <textarea name="Comment" class="form-control" rows="3"></textarea>
                </div>
            </div>

            <div class="mt-3">
                <a class="btn btn-outline-primary"
                   asp-controller="Enrollments"
                   asp-action="EnrolDocumentIndex"
                   asp-route-enrollmentId="@Model.Id">
                    Documents
                </a>
                <button class="btn btn-primary" type="submit">Update Status</button>
                <a class="btn btn-outline-secondary" asp-action="Index">Back</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">Status History</div>
    <div class="card-body">
        @if (!history.Any())
        {
            <div class="text-muted">No history yet.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Reason</th>
                            <th>Comment</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var h in history)
                        {
                            <tr>
                                <td>@h.StatusDate.ToString("yyyy-MM-dd")</td>
                                <td>@h.Status</td>
                                <td>@h.Reason</td>
                                <td>@h.Comment</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>