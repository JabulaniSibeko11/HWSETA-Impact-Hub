@model HWSETA_Impact_Hub.Domain.Entities.Enrollment
@using HWSETA_Impact_Hub.Domain.Entities
@{
    ViewData["Title"] = "Enrollment Details";
    var history = ViewBag.History as List<EnrollmentStatusHistory> ?? new();
    var statusVm = ViewBag.StatusVm as HWSETA_Impact_Hub.Models.ViewModels.Enrollment.EnrollmentStatusUpdateVm
                   ?? new HWSETA_Impact_Hub.Models.ViewModels.Enrollment.EnrollmentStatusUpdateVm { EnrollmentId = Model.Id };
}
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

<link href="~/css/enrollmentdetails.css" rel="stylesheet" />
@* Header *@
<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
    <div>
        <div class="hw-page-eyebrow"><i class="bi bi-person-check me-1"></i>Programme Management</div>
        <h1 class="hw-page-title">Enrolment <span>Details</span></h1>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap;">
        <a class="hw-btn-gold" asp-controller="Enrollments" asp-action="EnrolDocumentIndex" asp-route-enrollmentId="@Model.Id">
            <i class="bi bi-folder2-open"></i> Documents
        </a>
        <a asp-action="Index" class="hw-btn-outline"><i class="bi bi-arrow-left"></i> All Enrolments</a>
    </div>
</div>

@* Hero *@
<div class="hw-hero">
    <div class="hw-hero-label">Beneficiary</div>
    <div class="hw-hero-name">@Model.Beneficiary?.LastName, @Model.Beneficiary?.FirstName</div>
    <div class="hw-hero-sub">ID: @Model.Beneficiary?.IdentifierValue &nbsp;·&nbsp; Cohort: @Model.Cohort?.CohortCode</div>
    <div class="hw-hero-pills">
        <span class="hw-hero-pill"><i class="bi bi-mortarboard"></i> @Model.Cohort?.Programme?.ProgrammeName</span>
        <span class="hw-hero-pill"><i class="bi bi-building"></i> @Model.Cohort?.Provider?.ProviderName</span>
        @if (Model.Cohort?.Employer != null)
        {
            <span class="hw-hero-pill gold"><i class="bi bi-briefcase"></i> @Model.Cohort.Employer.EmployerCode</span>
        }
        @{
            var statusKey = Model.CurrentStatus.ToString().ToLower().Replace(" ", "").Replace("-", "");
        }
        <span class="hw-hero-pill"><i class="bi bi-circle-fill" style="font-size:8px;"></i> @Model.CurrentStatus</span>
    </div>
</div>

<div class="hw-detail-layout">

    @* Left column *@
    <div>

        @* Enrolment info *@
        <div class="hw-card">
            <div class="hw-card-head">
                <div class="hw-card-icon green"><i class="bi bi-person-lines-fill"></i></div>
                <div><div class="hw-card-title">Enrolment Information</div><div class="hw-card-sub">Core details of this enrolment record</div></div>
            </div>
            <div class="hw-card-body">
                <div class="hw-dl">
                    <div class="hw-dl-row">
                        <div class="hw-dl-icon green"><i class="bi bi-diagram-3"></i></div>
                        <div><div class="hw-dl-key">Cohort</div><div class="hw-dl-val">@Model.Cohort?.CohortCode</div></div>
                    </div>
                    <div class="hw-dl-row">
                        <div class="hw-dl-icon blue"><i class="bi bi-circle-fill" style="font-size:8px;"></i></div>
                        <div><div class="hw-dl-key">Current Status</div><div class="hw-dl-val"><span class="hw-sp sp-@statusKey">@Model.CurrentStatus</span></div></div>
                    </div>
                    <div class="hw-dl-row">
                        <div class="hw-dl-icon green"><i class="bi bi-play-circle"></i></div>
                        <div><div class="hw-dl-key">Start Date</div><div class="hw-dl-val">@Model.StartDate.ToString("dd MMMM yyyy")</div></div>
                    </div>
                    <div class="hw-dl-row">
                        <div class="hw-dl-icon @(Model.ActualEndDate.HasValue ? "red" : "dark")"><i class="bi bi-flag"></i></div>
                        <div><div class="hw-dl-key">Actual End Date</div><div class="hw-dl-val">@(Model.ActualEndDate.HasValue? Model.ActualEndDate.Value.ToString("dd MMMM yyyy") : "—  Not completed yet")</div></div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(Model.Notes))
                    {
                        <div class="hw-dl-row">
                            <div class="hw-dl-icon dark"><i class="bi bi-chat-left-text"></i></div>
                            <div><div class="hw-dl-key">Notes</div><div class="hw-dl-val">@Model.Notes</div></div>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* Update status *@
        <div class="hw-card">
            <div class="hw-card-head">
                <div class="hw-card-icon gold"><i class="bi bi-arrow-repeat"></i></div>
                <div><div class="hw-card-title">Update Status</div><div class="hw-card-sub">Record a new status change for this enrolment</div></div>
            </div>
            <div class="hw-card-body">
                <form asp-action="UpdateStatus" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="EnrollmentId" value="@statusVm.EnrollmentId" />
                    <div class="hw-g3" style="margin-bottom:14px;">
                        <div class="hw-field">
                            <label class="hw-field-label">New Status <span class="hw-req">*</span></label>
                            <div class="hw-field-wrap">
                                <i class="bi bi-circle hw-field-ico"></i>
                                <select name="Status" class="hw-select">
                                    @foreach (var s in Enum.GetValues(typeof(EnrollmentStatus)).Cast<EnrollmentStatus>())
                                    {
                                        <option value="@s" selected="@(s == Model.CurrentStatus)">@s</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="hw-field">
                            <label class="hw-field-label">Status Date <span class="hw-req">*</span></label>
                            <div class="hw-field-wrap">
                                <i class="bi bi-calendar3 hw-field-ico"></i>
                                <input name="StatusDate" type="date" class="hw-input" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>
                        <div class="hw-field">
                            <label class="hw-field-label">Reason</label>
                            <div class="hw-field-wrap">
                                <i class="bi bi-tag hw-field-ico"></i>
                                <input name="Reason" class="hw-input" placeholder="Optional reason" />
                            </div>
                        </div>
                    </div>
                    <div class="hw-field" style="margin-bottom:16px;">
                        <label class="hw-field-label">Comment</label>
                        <textarea name="Comment" class="hw-textarea" rows="3" placeholder="Additional notes about this status change…"></textarea>
                    </div>
                    <button class="hw-btn-primary" type="submit"><i class="bi bi-check-lg"></i> Update Status</button>
                </form>
            </div>
        </div>

        @* History timeline *@
        <div class="hw-card">
            <div class="hw-card-head">
                <div class="hw-card-icon dark"><i class="bi bi-clock-history"></i></div>
                <div>
                    <div class="hw-card-title">Status History</div>
                    <div class="hw-card-sub">@history.Count change@(history.Count == 1 ? "" : "s") recorded</div>
                </div>
            </div>
            <div class="hw-card-body" style="padding:0 20px;">
                @if (!history.Any())
                {
                    <div style="text-align:center;padding:28px 16px;color:var(--hw-muted);font-size:12.5px;">
                        <i class="bi bi-clock" style="font-size:26px;display:block;margin-bottom:8px;color:var(--hw-border);"></i>
                        No status changes recorded yet.
                    </div>
                }
                else
                {
                    <div class="hw-timeline">
                        @foreach (var h in history)
                        {
                            var hKey = h.Status.ToString().ToLower().Replace(" ", "").Replace("-", "");
                            var dotCss = hKey switch
                            {
                                "enrolled" => "green",
                                "active" => "blue",
                                "completed" => "purple",
                                "droppedout" or "dropout" => "red",
                                "withdrawn" => "gold",
                                _ => "dark"
                            };
                            <div class="hw-tl-item">
                                <div class="hw-tl-dot @dotCss"><i class="bi bi-circle-fill" style="font-size:8px;"></i></div>
                                <div style="flex:1;min-width:0;">
                                    <div class="hw-tl-date"><i class="bi bi-calendar3 me-1"></i>@h.StatusDate.ToString("dd MMM yyyy")</div>
                                    <div class="hw-tl-status">@h.Status</div>
                                    @if (!string.IsNullOrWhiteSpace(h.Reason))
                                    {
                                        <div class="hw-tl-reason"><i class="bi bi-tag me-1"></i>@h.Reason</div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(h.Comment))
                                    {
                                        <div class="hw-tl-comment">@h.Comment</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    @* Sidebar *@
    <div>
        <div class="hw-card">
            <div class="hw-card-head">
                <div class="hw-card-icon blue"><i class="bi bi-building-gear"></i></div>
                <div><div class="hw-card-title">Cohort Summary</div></div>
            </div>
            <div class="hw-card-body">
                <div class="hw-dl">
                    <div class="hw-dl-row" style="padding:9px 0;">
                        <div class="hw-dl-icon green" style="width:26px;height:26px;font-size:12px;"><i class="bi bi-mortarboard"></i></div>
                        <div><div class="hw-dl-key">Programme</div><div class="hw-dl-val" style="font-size:12px;">@Model.Cohort?.Programme?.ProgrammeName</div></div>
                    </div>
                    <div class="hw-dl-row" style="padding:9px 0;">
                        <div class="hw-dl-icon gold" style="width:26px;height:26px;font-size:12px;"><i class="bi bi-building"></i></div>
                        <div><div class="hw-dl-key">Provider</div><div class="hw-dl-val" style="font-size:12px;">@Model.Cohort?.Provider?.ProviderName</div></div>
                    </div>
                    <div class="hw-dl-row" style="padding:9px 0;">
                        <div class="hw-dl-icon dark" style="width:26px;height:26px;font-size:12px;"><i class="bi bi-briefcase"></i></div>
                        <div><div class="hw-dl-key">Employer</div><div class="hw-dl-val" style="font-size:12px;">@(Model.Cohort?.Employer == null ? "—" : Model.Cohort.Employer.EmployerCode)</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top:16px;padding:14px 16px;background:var(--hw-gold-light);border:1.5px solid #f0d060;border-radius:12px;">
            <div style="display:flex;gap:9px;align-items:flex-start;">
                <i class="bi bi-folder2-open" style="color:var(--hw-gold-dark);font-size:15px;flex-shrink:0;margin-top:2px;"></i>
                <div>
                    <div style="font-size:12px;font-weight:700;color:var(--hw-dark);margin-bottom:4px;">Enrolment Documents</div>
                    <div style="font-size:11.5px;color:var(--hw-muted);line-height:1.5;margin-bottom:10px;">Upload proof-of-completion, ID copies, agreements and other supporting documents.</div>
                    <a class="hw-btn-gold" asp-controller="Enrollments" asp-action="EnrolDocumentIndex" asp-route-enrollmentId="@Model.Id" style="font-size:11.5px;padding:7px 14px;">
                        <i class="bi bi-folder2-open"></i> Manage Documents
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
