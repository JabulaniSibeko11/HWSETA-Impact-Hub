@model HWSETA_Impact_Hub.Models.ViewModels.Enrollment.EnrollmentCreateVm
@{
    ViewData["Title"] = "Create Enrollment";
}

<h1 class="mb-3">Create Enrollment</h1>

<form method="post">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="card mb-3">
        <div class="card-header">Filter Cohorts</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Programme</label>
                    <select asp-for="ProgrammeId" asp-items="Model.Programmes" class="form-select" id="programmeFilter">
                        <option value="">-- Any programme --</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Provider</label>
                    <select asp-for="ProviderId" asp-items="Model.Providers" class="form-select" id="providerFilter">
                        <option value="">-- Any provider --</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Employer</label>
                    <select asp-for="EmployerId" asp-items="Model.Employers" class="form-select" id="employerFilter">
                        <option value="">-- Any employer --</option>
                    </select>
                </div>
            </div>

            <div class="mt-3 small text-muted">
                Tip: Choose Programme + Provider to narrow down cohorts, then pick the correct cohort below.
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <label asp-for="CohortId" class="form-label">Cohort</label>
            <select asp-for="CohortId" class="form-select" id="cohortSelect">
                <option value="">-- Select cohort (use filters above) --</option>
            </select>
            <span asp-validation-for="CohortId" class="text-danger"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="BeneficiaryId" class="form-label">Beneficiary</label>
            <select asp-for="BeneficiaryId" asp-items="Model.Beneficiaries" class="form-select">
                <option value="">-- Select beneficiary --</option>
            </select>
            <span asp-validation-for="BeneficiaryId" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label asp-for="StartDate" class="form-label">Start Date (optional)</label>
            <input asp-for="StartDate" type="date" class="form-control" />
            <div class="form-text">If empty, the cohort start date will be used.</div>
        </div>

        <div class="col-md-8">
            <label asp-for="Notes" class="form-label">Notes</label>
            <input asp-for="Notes" class="form-control" />
            <span asp-validation-for="Notes" class="text-danger"></span>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" type="submit">Save</button>
        <a class="btn btn-outline-secondary" asp-action="Index">Cancel</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        async function loadCohorts() {
            const programmeId = document.getElementById('programmeFilter').value;
            const providerId = document.getElementById('providerFilter').value;
            const employerId = document.getElementById('employerFilter').value;

            const url = '@Url.Action("GetCohorts", "Enrollments")'
                + '?programmeId=' + encodeURIComponent(programmeId)
                + '&providerId=' + encodeURIComponent(providerId)
                + '&employerId=' + encodeURIComponent(employerId);

            const res = await fetch(url);
            const data = await res.json();

            const sel = document.getElementById('cohortSelect');
            sel.innerHTML = '<option value="">-- Select cohort --</option>';

            for (const item of data) {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.text = item.text;
                sel.appendChild(opt);
            }
        }

        document.getElementById('programmeFilter').addEventListener('change', loadCohorts);
        document.getElementById('providerFilter').addEventListener('change', loadCohorts);
        document.getElementById('employerFilter').addEventListener('change', loadCohorts);

        // Load cohorts on page load if filters are pre-selected
        loadCohorts();
    </script>
}